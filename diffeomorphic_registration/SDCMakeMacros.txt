MACRO(ADD_MEX_FILE Target)
   INCLUDE_DIRECTORIES(${MATLAB_INCLUDE_DIR})
   ADD_LIBRARY(${Target} SHARED ${ARGN} ${MATLAB_INCLUDE_DIR}/../src/mexversion.c)
   TARGET_LINK_LIBRARIES(${Target} ${MATLAB_MX_LIBRARY} ${MATLAB_MEX_LIBRARY} ${MATLAB_MAT_LIBRARY} m)

   SET_TARGET_PROPERTIES(${Target} PROPERTIES PREFIX "")
   
   IF(CMAKE_SIZEOF_VOID_P MATCHES "4")
      SET_TARGET_PROPERTIES(${Target} PROPERTIES SUFFIX ".mexglx")
   ELSEIF(CMAKE_SIZEOF_VOID_P MATCHES "8")
      SET_TARGET_PROPERTIES(${Target} PROPERTIES SUFFIX ".mexa64")
   ELSE(CMAKE_SIZEOF_VOID_P MATCHES "4")
      MESSAGE(FATAL_ERROR "CMAKE_SIZEOF_VOID_P (${CMAKE_SIZEOF_VOID_P}) doesn't indicate a valid platform")
   ENDIF(CMAKE_SIZEOF_VOID_P MATCHES "4")

   SET(MATLAB_FLAGS "-fPIC -D_GNU_SOURCE -pthread -D_FILE_OFFSET_BITS=64 -DMX_COMPAT_32")

   MZ_APPEND_TARGET_PROPERTIES(${Target} COMPILE_FLAGS ${MATLAB_FLAGS})

   IF(CMAKE_SIZEOF_VOID_P MATCHES "4")
      SET_TARGET_PROPERTIES(${Target} PROPERTIES LINK_FLAGS "-Wl,-E -Wl,--no-undefined -Wl,--version-script,${MATLAB_INCLUDE_DIR}/../lib/glnx86/mexFunction.map")
   ELSEIF(CMAKE_SIZEOF_VOID_P MATCHES "8")
      SET_TARGET_PROPERTIES(${Target} PROPERTIES LINK_FLAGS "-Wl,-E -Wl,--no-undefined -Wl,--version-script,${MATLAB_INCLUDE_DIR}/../lib/glnxa64/mexFunction.map")
   ELSE(CMAKE_SIZEOF_VOID_P MATCHES "4")
      MESSAGE(FATAL_ERROR "CMAKE_SIZEOF_VOID_P (${CMAKE_SIZEOF_VOID_P}) doesn't indicate a valid platform")
   ENDIF(CMAKE_SIZEOF_VOID_P MATCHES "4")
ENDMACRO(ADD_MEX_FILE)


MACRO(MZ_APPEND_TARGET_PROPERTIES TARGET_TO_CHANGE PROP_TO_CHANGE)
  GET_TARGET_PROPERTY(_oldProps ${TARGET_TO_CHANGE} ${PROP_TO_CHANGE})
  IF( _oldProps )
    FOREACH(_newProp ${ARGN})
      IF( "_oldProps" MATCHES "^${_newProp}*" )
      ELSE( "_oldProps" MATCHES "^${_newProp}*" )
        SET_TARGET_PROPERTIES( ${TARGET_TO_CHANGE} PROPERTIES ${PROP_TO_CHANGE} "${_newProp} ${_oldProps}")
      ENDIF( "_oldProps" MATCHES "^${_newProp}*" )
    ENDFOREACH(_newProp ${ARGN})
  ELSE( _oldProps )
    SET_TARGET_PROPERTIES(${TARGET_TO_CHANGE} PROPERTIES ${PROP_TO_CHANGE} ${ARGN})
  ENDIF( _oldProps )
ENDMACRO(MZ_APPEND_TARGET_PROPERTIES TARGET_TO_CHANGE PROP_TO_CHANGE)
